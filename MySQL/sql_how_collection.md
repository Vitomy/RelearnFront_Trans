### 数据库表的空间回收
InnoDB表包含两部分，即:表结构定义和数据。已经把表结构的定义挡在系统数据表中了。<br>
简单滴删除表数据达不到空间回收的效果。<br>
#### 参数innodb_file_per_table
表数据既可以存在共享表空间里，也可以是单独的文件。由参数innodb_file_per_table控制的。<br>
* OFF表示数据放在共享表空间，也就是跟数据字典放在一起
* ON表示，每个InnoDB表数据存储在一个以.ibd为后缀的文件中

一个表单独存储为一个文件更容易管理。而且不需要的时候，通过drop table命令，直接删除这个文件，如果放在共享表空间中跟，即使表删掉了，空间也是不会回收的。<br>

#### 数据的删除流程
如果我们删除一个数据页上的所有记录，整个页就可以被复用了。数据页的复用跟记录的复用是不同的。<br>
被标记为可复用，但是磁盘上文件是不会变小的。<br>
不止是删除数据会造成空洞，插入数据也会造成空洞。<br>
通过大量的增删改，都是可能会存在空洞的。如果能够把这些空洞去掉，就能达到收缩表空间的目的<br>
#### 重建表，可以把空洞去掉
将表A的数据重新写到表B。可以使用`alter table A engine = InnoDB`命令来重建表。自动完成转存数据、交换表名、删除旧表的操作。<br>

#### OnLine DDL 数据定义语言 create table view
* 建立一个临时文件，扫描表A主键的所有数据页
* 用数据页中表A的记录生成B+树，存储到临时文件中
* 生成临时文件的过程中，将所有对A的操作记录在一个日志文件(row log)中
* 临时文件生成后，将日志文件的操作应用到临时文件，得到一个逻辑数据上与表A相同的数据文件
* 用临时文件替换表A的数据文件

#### Online和inplace
表A数据导出来存放位置叫作tmp_table。这是一个临时表，是在server层创建的。根据表A重建出来的数据放在tmp_file里，这个临时文件是InnoDB在内部创建出来的。整个DDL过程都在InnoDB内部完成。对于server层来说，没有把数据挪动到临时表中，是一个原地操作，就是inplace名称的来源。<br>

* DDL过程如果是Online的，就一定是inplace的
* 反过来未必，也就是说inplace的DDL，有可能不是Online的。截止到MySQL8.0 添加全文索引(FullText index)和空间索引(SPATIAL index)就属于这种情况

* alter table t engine = InnoDB也就是recreate默认的就是收缩空间的流程
* analyze table t其实不是重建表，只是对表的索引信息做重新统计，没有修改数据，这个过程中加了MDL读锁
* optimize table t等于recreate+analyze

